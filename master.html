<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Master - Sistema de Pontua√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getDatabase, ref, set, remove, onValue, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBudmIz5XvRzhlOfj0wHI0W5EIles3wsmY",
            authDomain: "contador-de-pontos-321ee.firebaseapp.com",
            projectId: "contador-de-pontos-321ee",
            storageBucket: "contador-de-pontos-321ee.firebasestorage.app",
            messagingSenderId: "817191889469",
            appId: "1:817191889469:web:cfb88023612f6b37491854",
            databaseURL: "https://contador-de-pontos-321ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.rtdb = getDatabase(app);
        window.fbModules = { collection, getDocs, setDoc, doc, deleteDoc, ref, set, remove, onValue, update };
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const CLIENT_URL = 'https://alpces.github.io/score/client.html';

        const playBuzzer = () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 0.3);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.6);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 0.9);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 1.2);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 1.5);
            
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime + 1.8);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 2);
        };

        const playSiren = () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            
            // Sirene com modula√ß√£o de frequ√™ncia
            const now = audioContext.currentTime;
            for (let i = 0; i < 10; i++) {
                oscillator.frequency.setValueAtTime(400, now + i * 0.5);
                oscillator.frequency.linearRampToValueAtTime(800, now + i * 0.5 + 0.25);
                oscillator.frequency.linearRampToValueAtTime(400, now + i * 0.5 + 0.5);
            }
            
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 5);
            
            oscillator.start(now);
            oscillator.stop(now + 5);
        };

        window.addEventListener('firebaseReady', () => {
            const { useState, useEffect, createElement: h } = React;
            const { db, rtdb, fbModules } = window;
            const { collection, getDocs, setDoc, doc, deleteDoc, ref, set, remove, onValue, update } = fbModules;

            function App() {
                const [setupComplete, setSetupComplete] = useState(false);
                const [numTables, setNumTables] = useState(0);
                const [initialScore, setInitialScore] = useState(1);
                const [buzzerText, setBuzzerText] = useState('BUZZER');
                const [blockBuzzerAtZero, setBlockBuzzerAtZero] = useState(true);
                const [countdownMinutes, setCountdownMinutes] = useState(0);
                const [countdownSeconds, setCountdownSeconds] = useState(0);
                const [customText, setCustomText] = useState('');
                const [tables, setTables] = useState([]);
                const [categories, setCategories] = useState([]);
                const [yellowCategory, setYellowCategory] = useState(null);
                const [redCategory, setRedCategory] = useState(null);
                const [usedCategories, setUsedCategories] = useState([]);
                const [showLeaderboard, setShowLeaderboard] = useState(false);
                const [leaderboardRevealPosition, setLeaderboardRevealPosition] = useState(null);
                const [tempNames, setTempNames] = useState({});
                const [tempCategories, setTempCategories] = useState(['']);
                const [predefinedCategories, setPredefinedCategories] = useState([]);
                const [showPredefined, setShowPredefined] = useState(false);
                const [showScores, setShowScores] = useState(false);
                const [flashEffects, setFlashEffects] = useState({});
                const [sessionId, setSessionId] = useState(null);
                const [codeCopied, setCodeCopied] = useState(false);
                const [connectedClients, setConnectedClients] = useState({});
                const [buzzers, setBuzzers] = useState({});
                const [showQRCode, setShowQRCode] = useState(false);
                const [showHistory, setShowHistory] = useState(false);
                const [sessionHistory, setSessionHistory] = useState([]);
                const [selectedHistoryEntry, setSelectedHistoryEntry] = useState(null);
                const [showSaveModal, setShowSaveModal] = useState(false);
                const [saveDescription, setSaveDescription] = useState('');
                const [countdownTime, setCountdownTime] = useState(null);
                const [countdownStarted, setCountdownStarted] = useState(false);
                const [countdownPaused, setCountdownPaused] = useState(true);

                useEffect(() => {
                    (async () => {
                        try {
                            const snap = await getDocs(collection(db, 'categories'));
                            const cats = [];
                            snap.forEach(d => cats.push(d.data().name));
                            setPredefinedCategories(cats.sort());
                        } catch (e) { console.error(e); }
                    })();
                }, []);

                useEffect(() => {
                    if (!sessionId) return;
                    const clients = ref(rtdb, `sessions/${sessionId}/clients`);
                    const unsubscribe = onValue(clients, (snap) => {
                        setConnectedClients(snap.val() || {});
                    });
                    return unsubscribe;
                }, [sessionId]);

                useEffect(() => {
                    if (!sessionId) return;
                    const buzzersRef = ref(rtdb, `sessions/${sessionId}/buzzers`);
                    const unsubscribe = onValue(buzzersRef, (snap) => {
                        setBuzzers(snap.val() || {});
                    });
                    return unsubscribe;
                }, [sessionId]);

                useEffect(() => {
                    if (!sessionId || !countdownStarted || countdownPaused || countdownTime === null || countdownTime <= 0) return;

                    const interval = setInterval(() => {
                        setCountdownTime(prev => {
                            if (prev <= 1) {
                                // Tempo terminou
                                playSiren();
                                setShowQRCode(false);
                                setCountdownStarted(false);
                                setCountdownPaused(true);
                                
                                // Enviar sinal para clientes tocarem sirene
                                const sirenRef = ref(rtdb, `sessions/${sessionId}/sirenSignal`);
                                set(sirenRef, Date.now());
                                
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);

                    return () => clearInterval(interval);
                }, [countdownStarted, countdownPaused, countdownTime, sessionId]);

                const generateSessionId = () => {
                    return Math.random().toString(36).substring(2, 8).toUpperCase();
                };

                const generateQRCodeUrl = () => {
                    const url = `${CLIENT_URL}?session=${sessionId}`;
                    return `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(url)}`;
                };

                const loadHistory = async () => {
                    try {
                        const snap = await getDocs(collection(db, 'sessions'));
                        const history = [];
                        snap.forEach(d => history.push({ id: d.id, ...d.data() }));
                        history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        setSessionHistory(history);
                    } catch (e) { console.error(e); }
                };

                const startGame = async () => {
                    const sid = generateSessionId();
                    setSessionId(sid);
                    
                    const totalTime = countdownMinutes * 60 + countdownSeconds;
                    if (totalTime > 0) {
                        setCountdownTime(totalTime);
                        setCountdownStarted(false);
                        setCountdownPaused(true);
                    }

                    const newTables = Array.from({ length: numTables }, (_, i) => ({
                        id: i + 1,
                        name: tempNames[i + 1] || '',
                        score: initialScore
                    }));
                    setTables(newTables);

                    const cats = tempCategories.filter(c => c.trim());
                    setCategories(cats);

                    const gameState = {
                        tables: newTables,
                        categories: cats,
                        yellowCategory: null,
                        redCategory: null,
                        usedCategories: [],
                        initialScore,
                        buzzerText,
                        blockBuzzerAtZero
                    };

                    await set(ref(rtdb, `sessions/${sid}/gameState`), gameState);
                    setSetupComplete(true);
                };

                const updateScore = async (tableId, delta) => {
                    const newTables = tables.map(t => {
                        if (t.id === tableId) {
                            const newScore = Math.max(0, t.score + delta);
                            
                            setFlashEffects(prev => ({ ...prev, [tableId]: delta > 0 ? `+${delta}` : delta }));
                            setTimeout(() => {
                                setFlashEffects(prev => {
                                    const { [tableId]: _, ...rest } = prev;
                                    return rest;
                                });
                            }, 600);
                            
                            return { ...t, score: newScore };
                        }
                        return t;
                    });

                    setTables(newTables);
                    await update(ref(rtdb, `sessions/${sessionId}/gameState`), { tables: newTables });
                };

                const changeCategory = async (setter, current) => {
                    const available = categories.filter(c => !usedCategories.includes(c) && c !== current);
                    if (available.length === 0) {
                        alert('Sem categorias dispon√≠veis!');
                        return;
                    }
                    const cat = available[Math.floor(Math.random() * available.length)];
                    setter(cat);
                    const newUsed = [...usedCategories, cat].filter(c => c !== current);
                    setUsedCategories(newUsed);
                    
                    const updates = setter === setYellowCategory 
                        ? { yellowCategory: cat, usedCategories: newUsed }
                        : { redCategory: cat, usedCategories: newUsed };
                    await update(ref(rtdb, `sessions/${sessionId}/gameState`), updates);
                };

                const resetAllScores = async () => {
                    if (!confirm('Resetar todas as pontua√ß√µes?')) return;
                    const newTables = tables.map(t => ({ ...t, score: initialScore }));
                    setTables(newTables);
                    await update(ref(rtdb, `sessions/${sessionId}/gameState`), { tables: newTables });
                };

                const resetGame = async () => {
                    if (!confirm('Iniciar nova sess√£o? Os clientes ser√£o desconectados.')) return;
                    if (sessionId) {
                        await remove(ref(rtdb, `sessions/${sessionId}`));
                    }
                    setSessionId(null);
                    setSetupComplete(false);
                    setTables([]);
                    setYellowCategory(null);
                    setRedCategory(null);
                    setUsedCategories([]);
                    setBuzzers({});
                    setShowQRCode(false);
                    setCountdownTime(null);
                    setCountdownStarted(false);
                    setCountdownPaused(true);
                };

                const sorted = () => [...tables].sort((a, b) => b.score - a.score);

                const resetBuzzer = async (tableId) => {
                    const buzzerRef = ref(rtdb, `sessions/${sessionId}/buzzers/${tableId}`);
                    await set(buzzerRef, { pressed: false, enabled: true, timestamp: null });
                };

                const resetAllBuzzers = async () => {
                    const buzzersRef = ref(rtdb, `sessions/${sessionId}/buzzers`);
                    const updates = {};
                    Object.keys(buzzers).forEach(tableId => {
                        updates[tableId] = { pressed: false, enabled: true, timestamp: null };
                    });
                    await update(buzzersRef, updates);
                };

                const getBuzzerOrder = () => {
                    return Object.entries(buzzers)
                        .filter(([_, b]) => b.pressed && b.timestamp)
                        .sort((a, b) => a[1].timestamp - b[1].timestamp)
                        .map(([tableId, b], index) => ({ tableId, order: index + 1, ...b }));
                };

                const saveSession = async () => {
                    try {
                        const sessionData = {
                            timestamp: Date.now(),
                            description: saveDescription,
                            numTables,
                            initialScore,
                            buzzerText,
                            blockBuzzerAtZero,
                            categories: tempCategories.filter(c => c.trim()),
                            tableNames: tempNames
                        };
                        await setDoc(doc(db, 'sessions', `session_${Date.now()}`), sessionData);
                        alert('Sess√£o gravada com sucesso!');
                        setShowSaveModal(false);
                        setSaveDescription('');
                    } catch (e) {
                        console.error(e);
                        alert('Erro ao gravar sess√£o');
                    }
                };

                const loadSession = (entry) => {
                    setNumTables(entry.numTables || 0);
                    setInitialScore(entry.initialScore || 1);
                    setBuzzerText(entry.buzzerText || 'BUZZER');
                    setBlockBuzzerAtZero(entry.blockBuzzerAtZero !== undefined ? entry.blockBuzzerAtZero : true);
                    setTempCategories(entry.categories || ['']);
                    setTempNames(entry.tableNames || {});
                    setShowHistory(false);
                    setSelectedHistoryEntry(null);
                };

                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };

                const handleQRCodeClick = () => {
                    if (!countdownStarted && countdownTime > 0) {
                        setCountdownStarted(true);
                        setCountdownPaused(false);
                    } else if (countdownStarted) {
                        setShowQRCode(false);
                    }
                };

                if (!setupComplete) {
                    return h('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-4 overflow-auto' },
                        h('div', { className: 'max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8' },
                            h('h1', { className: 'text-4xl font-black text-gray-800 mb-8 text-center' }, 'Configura√ß√£o do Jogo'),
                            !showHistory && !showPredefined && h('div', { className: 'space-y-6' },
                                h('div', { className: 'flex gap-4' },
                                    h('button', { onClick: () => { loadHistory(); setShowHistory(true); }, className: 'flex-1 py-3 bg-cyan-500 text-white rounded-lg font-bold hover:bg-cyan-600' }, 'üìã Carregar Sess√£o Gravada'),
                                    h('button', { onClick: () => setShowPredefined(true), className: 'flex-1 py-3 bg-indigo-500 text-white rounded-lg font-bold hover:bg-indigo-600' }, 'üìö Categorias Pr√©-definidas')
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'N√∫mero de Mesas'),
                                    h('input', { type: 'number', min: 1, max: 20, value: numTables || '', onChange: (e) => setNumTables(parseInt(e.target.value) || 0), className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Pontua√ß√£o Inicial'),
                                    h('input', { type: 'number', min: 0, value: initialScore, onChange: (e) => setInitialScore(parseInt(e.target.value) || 0), className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Texto do Buzzer'),
                                    h('input', { type: 'text', value: buzzerText, onChange: (e) => setBuzzerText(e.target.value), className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                ),
                                h('div', { className: 'flex items-center gap-3 bg-gray-50 p-4 rounded-lg' },
                                    h('input', { type: 'checkbox', id: 'blockBuzzer', checked: blockBuzzerAtZero, onChange: (e) => setBlockBuzzerAtZero(e.target.checked), className: 'w-5 h-5' }),
                                    h('label', { htmlFor: 'blockBuzzer', className: 'text-sm font-bold text-gray-700' }, 'Bloquear buzzer quando pontua√ß√£o = 0')
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Tempo para In√≠cio do Jogo'),
                                    h('div', { className: 'flex gap-4' },
                                        h('div', { className: 'flex-1' },
                                            h('label', { className: 'block text-xs text-gray-600 mb-1' }, 'Minutos'),
                                            h('input', { type: 'number', min: 0, max: 60, value: countdownMinutes, onChange: (e) => setCountdownMinutes(parseInt(e.target.value) || 0), className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                        ),
                                        h('div', { className: 'flex-1' },
                                            h('label', { className: 'block text-xs text-gray-600 mb-1' }, 'Segundos'),
                                            h('input', { type: 'number', min: 0, max: 59, value: countdownSeconds, onChange: (e) => setCountdownSeconds(parseInt(e.target.value) || 0), className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                        )
                                    )
                                ),
                                (countdownMinutes > 0 || countdownSeconds > 0) && h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Texto Personalizado (m√°x. 500 caracteres)'),
                                    h('textarea', { 
                                        value: customText, 
                                        onChange: (e) => setCustomText(e.target.value.slice(0, 500)), 
                                        maxLength: 500,
                                        rows: 3,
                                        placeholder: 'Texto que aparecer√° no ecr√£ inicial...',
                                        className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 resize-none' 
                                    }),
                                    h('div', { className: 'text-xs text-gray-500 mt-1 text-right' }, `${customText.length}/500`)
                                ),
                                numTables > 0 && h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Nomes das Mesas (Opcional)'),
                                    h('div', { className: 'grid grid-cols-2 gap-3 max-h-60 overflow-y-auto' },
                                        Array.from({ length: numTables }, (_, i) => i + 1).map(id =>
                                            h('div', { key: id, className: 'flex items-center gap-2' },
                                                h('span', { className: 'text-sm font-bold text-gray-600 w-12' }, `M${id}:`),
                                                h('input', { type: 'text', value: tempNames[id] || '', onChange: (e) => setTempNames({ ...tempNames, [id]: e.target.value }), placeholder: `Mesa ${id}`, className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' })
                                            )
                                        )
                                    )
                                ),
                                h('div', null,
                                    h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Categorias'),
                                    h('div', { className: 'space-y-2 max-h-60 overflow-y-auto' },
                                        tempCategories.map((cat, i) =>
                                            h('div', { key: i, className: 'flex gap-2' },
                                                h('input', { type: 'text', value: cat, onChange: (e) => { const n = [...tempCategories]; n[i] = e.target.value; setTempCategories(n); }, placeholder: `Categoria ${i + 1}`, className: 'flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500' }),
                                                tempCategories.length > 1 && h('button', { onClick: () => setTempCategories(tempCategories.filter((_, idx) => idx !== i)), className: 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-bold' }, '‚úï')
                                            )
                                        )
                                    ),
                                    h('button', { onClick: () => setTempCategories([...tempCategories, '']), className: 'mt-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold' }, '+ Adicionar Categoria')
                                ),
                                h('button', { onClick: startGame, disabled: numTables === 0 || tempCategories.filter(c => c.trim()).length === 0, className: `w-full py-4 rounded-lg text-xl font-black transition-all ${numTables === 0 || tempCategories.filter(c => c.trim()).length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:from-purple-700 hover:to-pink-700 shadow-lg'}` }, 'Iniciar Jogo')
                            ),
                            showHistory && h('div', null,
                                h('button', { onClick: () => setShowHistory(false), className: 'mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold' }, '‚Üê Voltar'),
                                h('h2', { className: 'text-2xl font-bold mb-4' }, 'Sess√µes Gravadas'),
                                sessionHistory.length === 0 && h('p', { className: 'text-gray-500 text-center py-8' }, 'Nenhuma sess√£o gravada'),
                                h('div', { className: 'space-y-3 max-h-96 overflow-y-auto' },
                                    sessionHistory.map(entry =>
                                        h('div', { key: entry.id, className: 'bg-gray-50 p-4 rounded-lg border-2 border-gray-200 hover:border-purple-500 cursor-pointer', onClick: () => loadSession(entry) },
                                            h('div', { className: 'font-bold text-gray-800' }, entry.description || 'Sem descri√ß√£o'),
                                            h('div', { className: 'text-sm text-gray-600 mt-1' }, `${entry.numTables} mesas ‚Ä¢ ${entry.categories?.length || 0} categorias`),
                                            h('div', { className: 'text-xs text-gray-400 mt-1' }, new Date(entry.timestamp).toLocaleString('pt-PT'))
                                        )
                                    )
                                )
                            ),
                            showPredefined && h('div', null,
                                h('button', { onClick: () => setShowPredefined(false), className: 'mb-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold' }, '‚Üê Voltar'),
                                h('h2', { className: 'text-2xl font-bold mb-4' }, 'Categorias Pr√©-definidas'),
                                predefinedCategories.length === 0 && h('p', { className: 'text-gray-500 text-center py-8' }, 'Nenhuma categoria pr√©-definida'),
                                h('div', { className: 'grid grid-cols-2 gap-2 max-h-96 overflow-y-auto' },
                                    predefinedCategories.map(cat =>
                                        h('button', { key: cat, onClick: () => { if (!tempCategories.includes(cat)) { setTempCategories([...tempCategories.filter(c => c.trim()), cat]); } }, className: `p-3 text-left border-2 rounded-lg hover:bg-purple-50 hover:border-purple-500 ${tempCategories.includes(cat) ? 'bg-purple-100 border-purple-500' : 'bg-white border-gray-200'}` }, cat)
                                    )
                                )
                            )
                        )
                    );
                }

                if (showSaveModal) {
                    return h('div', { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50' },
                        h('div', { className: 'bg-white rounded-2xl p-8 max-w-md w-full' },
                            h('h2', { className: 'text-2xl font-bold mb-4' }, 'Gravar Sess√£o'),
                            h('label', { className: 'block text-sm font-bold text-gray-700 mb-2' }, 'Descri√ß√£o'),
                            h('input', { type: 'text', value: saveDescription, onChange: (e) => setSaveDescription(e.target.value), placeholder: 'Ex: Quiz de Natal 2024', className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 mb-4' }),
                            h('div', { className: 'flex gap-3' },
                                h('button', { onClick: () => setShowSaveModal(false), className: 'flex-1 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600' }, 'Cancelar'),
                                h('button', { onClick: saveSession, className: 'flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700' }, 'Gravar')
                            )
                        )
                    );
                }

                if (showLeaderboard) {
                    const sortedTables = sorted();
                    return h('div', { className: 'h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-600 p-4 flex items-center justify-center' },
                        h('div', { className: 'w-full max-w-4xl' },
                            h('div', { className: 'text-center mb-8' },
                                h('h1', { className: 'text-6xl font-black text-white mb-4 drop-shadow-lg' }, 'üèÜ CLASSIFICA√á√ÉO üèÜ')
                            ),
                            h('div', { className: 'space-y-3' },
                                sortedTables.map((t, index) => {
                                    const visible = leaderboardRevealPosition === null || index < leaderboardRevealPosition;
                                    return h('div', { key: t.id, className: `bg-white rounded-2xl p-6 shadow-2xl transform transition-all duration-500 ${visible ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}`, style: { transitionDelay: `${index * 100}ms` } },
                                        h('div', { className: 'flex items-center justify-between' },
                                            h('div', { className: 'flex items-center gap-4' },
                                                h('div', { className: `text-4xl font-black ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-600'}` }, `${index + 1}¬∫`),
                                                h('div', null,
                                                    h('div', { className: 'text-2xl font-bold text-gray-800' }, t.name || `Mesa ${t.id}`),
                                                    h('div', { className: 'text-sm text-gray-500' }, `Mesa ${t.id}`)
                                                )
                                            ),
                                            h('span', { className: 'text-2xl font-bold' }, `${t.score} pts`)
                                        )
                                    );
                                })
                            ),
                            h('div', { className: 'text-center mt-8' },
                                leaderboardRevealPosition !== null && leaderboardRevealPosition > 0 && h('button', { onClick: () => { if (leaderboardRevealPosition > 1) setLeaderboardRevealPosition(leaderboardRevealPosition - 1); }, className: 'px-8 py-4 bg-white text-purple-600 rounded-full font-black text-xl hover:bg-gray-100 shadow-xl mr-4' }, '‚Üê Revelar Anterior'),
                                h('button', { onClick: () => setShowLeaderboard(false), className: 'px-8 py-4 bg-white text-purple-600 rounded-full font-black text-xl hover:bg-gray-100 shadow-xl' }, 'Voltar ao Jogo')
                            )
                        )
                    );
                }

                if (showQRCode && sessionId) {
                    return h('div', { 
                        className: 'h-screen bg-gradient-to-br from-green-500 to-blue-600 flex p-8',
                        onClick: handleQRCodeClick
                    },
                        h('div', { className: 'flex-1 flex flex-col items-center justify-center' },
                            customText && h('div', { className: 'w-full text-center mb-8 px-4' },
                                h('p', { className: 'text-3xl md:text-5xl font-black text-white drop-shadow-lg leading-tight' }, customText)
                            ),
                            countdownTime > 0 && h('div', { className: 'mb-8' },
                                h('div', { className: 'text-7xl md:text-9xl font-black text-yellow-300 drop-shadow-2xl' }, formatTime(countdownTime)),
                                !countdownStarted && h('p', { className: 'text-xl text-white mt-4 opacity-80' }, 'Clica para iniciar contagem')
                            ),
                            h('div', { className: 'bg-white rounded-3xl p-8 shadow-2xl mb-6' },
                                h('img', { src: generateQRCodeUrl(), alt: 'QR Code', className: 'w-64 h-64 md:w-96 md:h-96' })
                            ),
                            h('div', { className: 'text-center' },
                                h('div', { className: 'text-sm text-white opacity-90 mb-2' }, 'C√ìDIGO DA SESS√ÉO'),
                                h('div', { className: 'text-6xl md:text-8xl font-black text-white tracking-widest drop-shadow-lg' }, sessionId)
                            ),
                            countdownStarted && h('p', { className: 'text-white text-xl mt-8 opacity-80' }, 'Clica para voltar')
                        ),
                        h('div', { className: 'w-1/6 flex flex-col items-center justify-center gap-8 p-4' },
                            [1, 2, 3, 4, 5].map(num =>
                                h('img', {
                                    key: num,
                                    src: `logo${num}.png`,
                                    alt: `Logo ${num}`,
                                    className: 'w-full h-auto rounded-lg shadow-lg',
                                    style: { maxHeight: '150px', objectFit: 'contain' },
                                    onError: (e) => { e.target.style.display = 'none'; }
                                })
                            )
                        )
                    );
                }

                const buzzerOrder = getBuzzerOrder();

                return h('div', { className: 'h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-2 flex flex-col overflow-auto' },
                    h('div', { className: 'max-w-7xl mx-auto w-full flex flex-col flex-1' },
                        buzzerOrder.length > 0 && h('div', { 
                            className: 'text-white rounded-lg p-3 mb-2',
                            style: { animation: 'buzzerFlash 1s ease-in-out infinite' }
                        },
                            h('div', { className: 'flex justify-between items-center mb-2' },
                                h('h3', { className: 'font-bold text-lg' }, 'Buzzers Ativos'),
                                h('button', { onClick: resetAllBuzzers, className: 'bg-white bg-opacity-20 px-3 py-1 rounded hover:bg-opacity-30 text-sm' }, 'Resetar Todos')
                            ),
                            h('div', { className: 'flex flex-wrap gap-2' },
                                buzzerOrder.map(b => h('div', { key: b.tableId, className: 'bg-white bg-opacity-20 px-3 py-2 rounded flex items-center gap-2' },
                                    h('span', { className: 'font-bold' }, `${b.order}¬∫`),
                                    h('span', null, `Mesa ${b.tableId}`),
                                    h('button', { onClick: () => resetBuzzer(b.tableId), className: 'bg-red-700 px-2 py-0.5 rounded text-xs hover:bg-red-800' }, 'Reset')
                                ))
                            )
                        ),
                        categories.length > 0 && h('div', { className: 'grid grid-cols-2 gap-3 mb-2', style: { height: sessionId ? 'calc(33.333% - 4rem)' : '33.333%' } },
                            h('button', { onDoubleClick: () => changeCategory(setYellowCategory, yellowCategory), className: 'bg-yellow-400 text-gray-900 rounded-xl p-4 font-black hover:bg-yellow-500 h-full flex items-center justify-center' },
                                h('span', { className: 'text-center text-3xl sm:text-4xl md:text-5xl lg:text-6xl' }, yellowCategory || 'Duplo clique')
                            ),
                            h('button', { onDoubleClick: () => changeCategory(setRedCategory, redCategory), className: 'bg-red-500 text-white rounded-xl p-4 font-black hover:bg-red-600 h-full flex items-center justify-center' },
                                h('span', { className: 'text-center text-3xl sm:text-4xl md:text-5xl lg:text-6xl' }, redCategory || 'Duplo clique')
                            )
                        ),
                        h('div', { className: 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-1.5 mb-2', style: { height: 'calc(66.666% - 3.5rem)' } },
                            tables.map(t => {
                                const hasBuzzer = buzzers[t.id]?.pressed;
                                const buzzerInfo = buzzerOrder.find(b => b.tableId === t.id);
                                return h('div', { key: t.id, className: `rounded-lg p-1 flex flex-col justify-between relative h-full ${hasBuzzer ? 'bg-red-500 animate-pulse' : 'bg-white'}` },
                                    flashEffects[t.id] && h('div', { className: 'absolute inset-0 flex items-center justify-center z-10 bg-black bg-opacity-50 rounded-lg' },
                                        h('span', { className: 'text-5xl font-bold text-white' }, flashEffects[t.id])
                                    ),
                                    hasBuzzer && h('div', { className: 'absolute top-0 right-0 bg-yellow-400 text-black rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold' }, buzzerInfo?.order),
                                    h('div', { className: `text-center mb-1 ${hasBuzzer ? 'text-white' : ''}` },
                                        h('div', { className: `text-2xl font-extrabold ${hasBuzzer ? 'text-white' : 'text-indigo-600'}` }, `M${t.id}`),
                                        t.name && h('div', { className: `text-[10px] truncate ${hasBuzzer ? 'text-white' : 'text-gray-600'}` }, t.name)
                                    ),
                                    h('div', { className: 'flex items-center justify-center gap-1 mb-1 flex-1' },
                                        h('button', { onClick: () => updateScore(t.id, -1), className: 'w-8 h-8 rounded-lg font-bold bg-gray-500 text-white hover:bg-gray-600' }, '-'),
                                        showScores && h('div', { className: `text-2xl font-bold w-10 text-center ${hasBuzzer ? 'text-white' : 'text-indigo-600'}` }, t.score),
                                        !showScores && h('div', { className: 'w-10' }),
                                        h('button', { onClick: () => updateScore(t.id, 1), className: 'w-8 h-8 rounded-lg font-bold bg-green-500 text-white hover:bg-green-600' }, '+')
                                    ),
                                    h('button', { onClick: () => updateScore(t.id, 5), className: 'w-full py-1 rounded-lg font-bold text-[10px] bg-purple-500 text-white hover:bg-purple-600' }, '+5')
                                );
                            })
                        ),
                        h('div', { className: 'flex justify-between bg-white rounded-lg p-2' },
                            h('div', { className: 'flex gap-2' },
                                h('button', { onClick: () => setShowScores(!showScores), className: 'px-3 py-1.5 text-xs bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600' }, showScores ? 'Ocultar' : 'Mostrar'),
                                sessionId && h('button', { onClick: () => { setShowQRCode(true); }, className: 'px-3 py-1.5 text-xs bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 flex items-center gap-1' }, 
                                    h('span', null, 'üì±'),
                                    h('span', null, 'QR Code')
                                )
                            ),
                            h('div', { className: 'flex gap-2' },
                                h('button', { onClick: () => setShowSaveModal(true), className: 'px-3 py-1.5 text-xs bg-cyan-500 text-white rounded-lg font-semibold hover:bg-cyan-600' }, 'Gravar Sess√£o'),
                                h('button', { onClick: () => { const s = sorted(); setLeaderboardRevealPosition(s.length > 5 ? 6 : s.length); setShowLeaderboard(true); }, className: 'px-3 py-1.5 text-xs bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600' }, 'Rank'),
                                h('button', { onClick: resetAllScores, className: 'px-3 py-1.5 text-xs bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600' }, 'Reset Pontos'),
                                h('button', { onClick: resetGame, className: 'px-3 py-1.5 text-xs bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700' }, 'Nova Sess√£o')
                            )
                        )
                    )
                );
            }

            const style = document.createElement('style');
            style.textContent = `
                @keyframes buzzerFlash {
                    0%, 100% { background-color: rgb(59, 130, 246); }
                    50% { background-color: rgb(30, 58, 138); }
                }
            `;
            document.head.appendChild(style);

            ReactDOM.createRoot(document.getElementById('root')).render(h(App));
        });
    </script>
</body>
</html>