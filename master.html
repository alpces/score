<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Master - Sistema de Pontuação</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getDatabase, ref, set, remove } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBudmIz5XvRzhlOfj0wHI0W5EIles3wsmY",
            authDomain: "contador-de-pontos-321ee.firebaseapp.com",
            projectId: "contador-de-pontos-321ee",
            storageBucket: "contador-de-pontos-321ee.firebasestorage.app",
            messagingSenderId: "817191889469",
            appId: "1:817191889469:web:cfb88023612f6b37491854",
            databaseURL: "https://contador-de-pontos-321ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.rtdb = getDatabase(app);
        window.fbModules = { collection, getDocs, setDoc, doc, deleteDoc, ref, set, remove };
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        window.addEventListener('firebaseReady', () => {
            const { useState, useEffect, createElement: h } = React;
            const { db, rtdb, fbModules } = window;
            const { collection, getDocs, setDoc, doc, deleteDoc, ref, set, remove } = fbModules;

            const SVG = ({ path, className = "w-6 h-6" }) => h('svg', { className, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' }, h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: path }));

            function App() {
                const [setupComplete, setSetupComplete] = useState(false);
                const [numTables, setNumTables] = useState(12);
                const [initialScore, setInitialScore] = useState(1);
                const [tables, setTables] = useState([]);
                const [categories, setCategories] = useState([]);
                const [yellowCategory, setYellowCategory] = useState(null);
                const [redCategory, setRedCategory] = useState(null);
                const [usedCategories, setUsedCategories] = useState([]);
                const [showLeaderboard, setShowLeaderboard] = useState(false);
                const [leaderboardRevealPosition, setLeaderboardRevealPosition] = useState(null);
                const [tempNames, setTempNames] = useState({});
                const [tempCategories, setTempCategories] = useState(['']);
                const [predefinedCategories, setPredefinedCategories] = useState([]);
                const [showPredefined, setShowPredefined] = useState(false);
                const [showScores, setShowScores] = useState(false);
                const [flashEffects, setFlashEffects] = useState({});
                const [sessionId, setSessionId] = useState(null);
                const [codeCopied, setCodeCopied] = useState(false);

                useEffect(() => {
                    (async () => {
                        try {
                            const snap = await getDocs(collection(db, 'categories'));
                            const cats = [];
                            snap.forEach(d => cats.push(d.data().name));
                            setPredefinedCategories(cats.sort());
                        } catch (e) { console.error(e); }
                    })();
                }, []);

                const saveCats = async (cats) => {
                    try {
                        const snap = await getDocs(collection(db, 'categories'));
                        await Promise.all([...snap.docs.map(d => deleteDoc(doc(db, 'categories', d.id)))]);
                        await Promise.all(cats.map((cat, i) => setDoc(doc(db, 'categories', `cat_${i}`), { name: cat })));
                        setPredefinedCategories(cats);
                    } catch (e) { console.error(e); }
                };

                const syncGame = async () => {
                    if (!sessionId) return;
                    try {
                        await set(ref(rtdb, `sessions/${sessionId}`), {
                            tables: tables.map(t => ({ id: t.id, name: t.name, score: t.score })),
                            yellowCategory, redCategory, categories, active: true, timestamp: Date.now()
                        });
                    } catch (e) { console.error(e); }
                };

                useEffect(() => { if (setupComplete && sessionId) syncGame(); }, [tables, yellowCategory, redCategory]);

                const initGame = () => {
                    setTables(Array.from({ length: numTables }, (_, i) => ({ id: i + 1, name: tempNames[i + 1] || '', score: initialScore })));
                    setCategories(tempCategories.filter(c => c.trim()));
                    setSessionId(Math.random().toString(36).substring(2, 8).toUpperCase());
                    setSetupComplete(true);
                };

                const updateScore = (id, change) => {
                    setTables(prev => prev.map(t => t.id === id ? { ...t, score: Math.max(0, t.score + change) } : t));
                    const txt = change > 0 ? `+${change}` : `${change}`;
                    setFlashEffects(p => ({ ...p, [id]: txt }));
                    setTimeout(() => setFlashEffects(p => { const u = { ...p }; delete u[id]; return u; }), 1000);
                };

                const changeCategory = (setter, current) => {
                    const avail = categories.filter(c => !usedCategories.includes(c) && c !== current);
                    if (!avail.length) return;
                    const cat = avail[Math.floor(Math.random() * avail.length)];
                    setUsedCategories([...usedCategories, cat]);
                    setter(cat);
                };

                const resetGame = async () => {
                    if (sessionId) try { await remove(ref(rtdb, `sessions/${sessionId}`)); } catch (e) {}
                    setSetupComplete(false); setTables([]); setCategories([]); setYellowCategory(null); setRedCategory(null);
                    setUsedCategories([]); setTempNames({}); setTempCategories(['']); setInitialScore(1);
                    setShowLeaderboard(false); setLeaderboardRevealPosition(null); setShowScores(false);
                    setFlashEffects({}); setSessionId(null); setCodeCopied(false);
                };

                const sorted = () => [...tables].sort((a, b) => b.score - a.score);

                if (!setupComplete) {
                    return h('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-3 overflow-y-auto' },
                        h('div', { className: 'max-w-2xl mx-auto py-4' },
                            h('div', { className: 'bg-white rounded-2xl shadow-2xl p-4' },
                                h('h1', { className: 'text-2xl font-bold text-gray-800 text-center mb-4' }, 'Configuração do Jogo'),
                                h('div', { className: 'space-y-4' },
                                    h('div', null,
                                        h('label', { className: 'block text-sm font-semibold mb-2' }, 'Número de Mesas (1-12)'),
                                        h('input', { type: 'number', min: 1, max: 12, value: numTables, onChange: e => setNumTables(Math.min(12, Math.max(1, +e.target.value || 1))), className: 'w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500 outline-none' })
                                    ),
                                    h('div', null,
                                        h('label', { className: 'block text-sm font-semibold mb-2' }, 'Pontuação Inicial'),
                                        h('input', { type: 'number', min: 0, value: initialScore, onChange: e => setInitialScore(Math.max(0, +e.target.value || 0)), className: 'w-full px-4 py-2 border-2 rounded-lg focus:border-indigo-500 outline-none' })
                                    ),
                                    h('div', null,
                                        h('label', { className: 'block text-sm font-semibold mb-2' }, 'Nomes das Mesas'),
                                        h('div', { className: 'grid gap-2 max-h-48 overflow-y-auto' },
                                            Array.from({ length: numTables }, (_, i) => h('div', { key: i, className: 'flex gap-2' },
                                                h('span', { className: 'text-sm w-16 pt-2' }, `Mesa ${i + 1}:`),
                                                h('input', { value: tempNames[i + 1] || '', onChange: e => setTempNames({ ...tempNames, [i + 1]: e.target.value }), className: 'flex-1 px-3 py-1.5 text-sm border rounded-lg outline-none' })
                                            ))
                                        )
                                    ),
                                    h('div', null,
                                        h('div', { className: 'flex justify-between mb-2' },
                                            h('label', { className: 'text-sm font-semibold' }, 'Categorias'),
                                            h('div', { className: 'space-x-2' },
                                                predefinedCategories.length > 0 && h('button', { onClick: () => setTempCategories([...predefinedCategories]), className: 'px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600' }, 'Carregar Guardadas'),
                                                h('button', { onClick: () => setShowPredefined(!showPredefined), className: 'px-3 py-1 bg-purple-500 text-white text-sm rounded hover:bg-purple-600' }, 'Gerir'),
                                                h('button', { onClick: () => setTempCategories([...tempCategories, '']), className: 'px-3 py-1 bg-indigo-500 text-white text-sm rounded hover:bg-indigo-600' }, '+')
                                            )
                                        ),
                                        showPredefined && h('div', { className: 'mb-3 p-3 bg-purple-50 rounded-lg' },
                                            h('h4', { className: 'text-sm font-bold mb-2' }, 'Categorias Guardadas'),
                                            predefinedCategories.map((cat, i) => h('div', { key: i, className: 'flex justify-between bg-white p-2 rounded mb-1' },
                                                h('span', { className: 'text-sm' }, cat),
                                                h('button', { onClick: () => saveCats(predefinedCategories.filter((_, x) => x !== i)), className: 'px-2 bg-red-500 text-white text-xs rounded' }, '✕')
                                            )),
                                            h('input', { placeholder: 'Nova categoria...', onKeyPress: e => { if (e.key === 'Enter' && e.target.value.trim()) { saveCats([...predefinedCategories, e.target.value.trim()].sort()); e.target.value = ''; } }, className: 'w-full mt-2 px-3 py-1.5 text-sm border rounded' })
                                        ),
                                        h('div', { className: 'space-y-2' },
                                            tempCategories.map((cat, i) => h('div', { key: i, className: 'flex gap-2' },
                                                h('input', { value: cat, onChange: e => { const n = [...tempCategories]; n[i] = e.target.value; setTempCategories(n); }, className: 'flex-1 px-3 py-1.5 text-sm border rounded outline-none' }),
                                                tempCategories.length > 1 && h('button', { onClick: () => setTempCategories(tempCategories.filter((_, x) => x !== i)), className: 'px-2 bg-red-500 text-white text-sm rounded' }, '✕')
                                            ))
                                        )
                                    ),
                                    h('button', { onClick: initGame, className: 'w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700' }, 'Iniciar Jogo')
                                )
                            )
                        )
                    );
                }

                if (showLeaderboard) {
                    const s = sorted();
                    const visible = s.slice(leaderboardRevealPosition - 1);
                    return h('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-3' },
                        h('div', { className: 'max-w-4xl mx-auto pt-4' },
                            h('div', { className: 'bg-white rounded-2xl p-4' },
                                h('div', { className: 'flex justify-between mb-4' },
                                    h('h2', { className: 'text-xl font-bold' }, '🏆 Classificação'),
                                    h('button', { onClick: () => { setShowLeaderboard(false); setLeaderboardRevealPosition(null); }, className: 'px-3 py-1.5 bg-gray-600 text-white rounded hover:bg-gray-700' }, 'Voltar')
                                ),
                                leaderboardRevealPosition > 1 && h('button', { onClick: () => setLeaderboardRevealPosition(leaderboardRevealPosition - 1), className: 'w-full bg-indigo-600 text-white py-3 rounded-lg font-bold mb-4 animate-pulse' }, `Revelar ${leaderboardRevealPosition - 1}º Lugar`),
                                h('div', { className: 'space-y-2' },
                                    visible.map(t => {
                                        const pos = s.indexOf(t) + 1;
                                        return h('div', { key: t.id, className: `flex justify-between p-3 rounded ${pos === 1 ? 'bg-yellow-400 text-white scale-105' : pos === 2 ? 'bg-gray-300' : pos === 3 ? 'bg-orange-400 text-white' : 'bg-gray-100'}` },
                                            h('div', null, h('span', { className: 'text-2xl font-bold mr-3' }, `${pos}º`), h('span', { className: 'font-bold' }, `Mesa ${t.id}`), t.name && h('span', { className: 'text-xs ml-2' }, t.name)),
                                            h('span', { className: 'text-2xl font-bold' }, `${t.score} pts`)
                                        );
                                    })
                                )
                            )
                        )
                    );
                }

                return h('div', { className: 'h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-2 flex flex-col overflow-auto' },
                    h('div', { className: 'max-w-7xl mx-auto w-full flex flex-col flex-1' },
                        sessionId && h('div', { className: 'bg-green-500 text-white rounded-lg p-3 mb-2 flex justify-between items-center' },
                            h('div', null,
                                h('div', { className: 'text-xs opacity-90' }, 'Código da Sessão:'),
                                h('div', { className: 'text-3xl font-black' }, sessionId)
                            ),
                            h('button', { onClick: () => { navigator.clipboard.writeText(sessionId); setCodeCopied(true); setTimeout(() => setCodeCopied(false), 2000); }, className: 'bg-white bg-opacity-20 p-3 rounded hover:bg-opacity-30' }, codeCopied ? '✓' : '📋')
                        ),
                        categories.length > 0 && h('div', { className: 'grid grid-cols-2 gap-3 mb-2', style: { height: sessionId ? 'calc(33.333% - 4rem)' : '33.333%' } },
                            h('button', { onDoubleClick: () => changeCategory(setYellowCategory, yellowCategory), className: 'bg-yellow-400 text-gray-900 rounded-xl p-4 font-black hover:bg-yellow-500 h-full flex items-center justify-center' },
                                h('span', { className: 'text-center text-3xl sm:text-4xl md:text-5xl lg:text-6xl' }, yellowCategory || 'Duplo clique')
                            ),
                            h('button', { onDoubleClick: () => changeCategory(setRedCategory, redCategory), className: 'bg-red-500 text-white rounded-xl p-4 font-black hover:bg-red-600 h-full flex items-center justify-center' },
                                h('span', { className: 'text-center text-3xl sm:text-4xl md:text-5xl lg:text-6xl' }, redCategory || 'Duplo clique')
                            )
                        ),
                        h('div', { className: 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-1.5 mb-2', style: { height: 'calc(66.666% - 3.5rem)' } },
                            tables.map(t => h('div', { key: t.id, className: 'bg-white rounded-lg p-1 flex flex-col justify-between relative h-full' },
                                flashEffects[t.id] && h('div', { className: 'absolute inset-0 flex items-center justify-center z-10 bg-black bg-opacity-50 rounded-lg' },
                                    h('span', { className: 'text-5xl font-bold text-white' }, flashEffects[t.id])
                                ),
                                h('div', { className: 'text-center mb-1' },
                                    h('div', { className: 'text-2xl font-extrabold text-indigo-600' }, `M${t.id}`),
                                    t.name && h('div', { className: 'text-[10px] text-gray-600 truncate' }, t.name)
                                ),
                                h('div', { className: 'flex items-center justify-center gap-1 mb-1 flex-1' },
                                    h('button', { onClick: () => updateScore(t.id, -1), className: 'w-8 h-8 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600' }, '-'),
                                    showScores && h('div', { className: 'text-2xl font-bold text-indigo-600 w-10 text-center' }, t.score),
                                    !showScores && h('div', { className: 'w-10' }),
                                    h('button', { onClick: () => updateScore(t.id, 1), className: 'w-8 h-8 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600' }, '+')
                                ),
                                h('button', { onClick: () => updateScore(t.id, 5), className: 'w-full bg-purple-500 text-white py-1 rounded-lg font-bold hover:bg-purple-600 text-[10px]' }, '+5')
                            ))
                        ),
                        h('div', { className: 'flex justify-between bg-white rounded-lg p-2' },
                            h('button', { onClick: () => setShowScores(!showScores), className: 'px-3 py-1.5 text-xs bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600' }, showScores ? '👁️ Ocultar' : '👁️ Mostrar'),
                            h('div', { className: 'flex gap-2' },
                                h('button', { onClick: () => { const s = sorted(); setLeaderboardRevealPosition(s.length > 5 ? 6 : s.length); setShowLeaderboard(true); }, className: 'px-3 py-1.5 text-xs bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600' }, '🏆 Rank'),
                                h('button', { onClick: resetGame, className: 'px-3 py-1.5 text-xs bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700' }, '🔄 Reset')
                            )
                        )
                    )
                );
            }

            ReactDOM.createRoot(document.getElementById('root')).render(h(App));
        });
    </script>
</body>
</html>