<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Cliente - Visualiza√ß√£o de Mesa</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- ==========================================
         CONFIGURA√á√ÉO DO FIREBASE
         ==========================================
         Inicializa conex√£o com Firebase Realtime Database
         para sincroniza√ß√£o em tempo real com o master
         ========================================== -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, onValue, set, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Configura√ß√£o da conta Firebase (mesma do master)
        const firebaseConfig = {
            apiKey: "AIzaSyBudmIz5XvRzhlOfj0wHI0W5EIles3wsmY",
            authDomain: "contador-de-pontos-321ee.firebaseapp.com",
            projectId: "contador-de-pontos-321ee",
            storageBucket: "contador-de-pontos-321ee.firebasestorage.app",
            messagingSenderId: "817191889469",
            appId: "1:817191889469:web:cfb88023612f6b37491854",
            databaseURL: "https://contador-de-pontos-321ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // Inicializa Firebase e disponibiliza globalmente
        const app = initializeApp(firebaseConfig);
        window.rtdb = getDatabase(app);
        window.fbModules = { ref, onValue, set, update };
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <!-- Bibliotecas React para constru√ß√£o da interface -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        /* ==========================================
           FUN√á√ÉO: playBuzzer()
           ==========================================
           Reproduz som de buzzer (id√™ntico ao master)
           - Alterna entre 800Hz e 650Hz
           - Dura√ß√£o: 2 segundos
           ========================================== */
        const playBuzzer = () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Padr√£o de frequ√™ncias
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 0.3);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.6);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 0.9);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 1.2);
            oscillator.frequency.setValueAtTime(650, audioContext.currentTime + 1.5);
            
            oscillator.type = 'sine';
            
            // Controle de volume
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime + 1.8);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 2);
        };

        window.addEventListener('firebaseReady', () => {
            const { useState, useEffect, createElement: h } = React;
            const { rtdb, fbModules } = window;
            const { ref, onValue, set, update } = fbModules;

            /* ==========================================
               COMPONENTE PRINCIPAL: App()
               ==========================================
               Componente React que gere a interface do cliente
               - Registo na sess√£o
               - Visualiza√ß√£o de pontua√ß√£o pr√≥pria
               - Bot√£o de buzzer
               - Sincroniza√ß√£o em tempo real com master
               ========================================== */
            function App() {
                // ========== ESTADOS DE REGISTO ==========
                const [registered, setRegistered] = useState(false);        // Se o cliente est√° registado
                const [sessionCode, setSessionCode] = useState('');         // C√≥digo da sess√£o
                const [tableNumber, setTableNumber] = useState('');         // N√∫mero da mesa (1-20)
                const [teamName, setTeamName] = useState('');               // Nome da equipa
                const [emails, setEmails] = useState(['']);                 // E-mails dos participantes
                const [error, setError] = useState('');                     // Mensagem de erro
                const [connecting, setConnecting] = useState(false);        // Estado de conex√£o

                // ========== ESTADOS DO JOGO ==========
                const [gameData, setGameData] = useState(null);             // Estado do jogo do master
                const [myTable, setMyTable] = useState(null);               // Dados da minha mesa
                const [buzzerState, setBuzzerState] = useState({ pressed: false, enabled: true });  // Estado do buzzer

                /* ==========================================
                   EFFECT: Verificar par√¢metro de sess√£o na URL
                   ==========================================
                   Se URL cont√©m ?session=XXX, preenche automaticamente
                   o c√≥digo da sess√£o (√∫til ao escanear QR code)
                   ========================================== */
                useEffect(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const session = urlParams.get('session');
                    if (session) {
                        setSessionCode(session.toUpperCase());
                    }
                }, []);

                /* ==========================================
                   EFFECT: Sincroniza√ß√£o com master
                   ==========================================
                   Ap√≥s registo, escuta mudan√ßas em:
                   1. gameState - Estado geral do jogo
                   2. buzzer - Estado do buzzer desta mesa
                   3. clients - Monitoriza se foi desconectado
                   ========================================== */
                useEffect(() => {
                    if (!registered || !sessionCode) return;

                    const gameStateRef = ref(rtdb, `sessions/${sessionCode}/gameState`);
                    const buzzerRef = ref(rtdb, `sessions/${sessionCode}/buzzers/${tableNumber}`);
                    const clientRef = ref(rtdb, `sessions/${sessionCode}/clients/${tableNumber}`);

                    // Monitorizar estado do jogo
                    const unsubGame = onValue(gameStateRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setGameData(data);
                            // Encontrar dados da minha mesa
                            const table = data.tables?.find(t => t.id === parseInt(tableNumber));
                            if (table) {
                                setMyTable(table);
                            }
                        }
                    });

                    // Monitorizar estado do buzzer
                    const unsubBuzzer = onValue(buzzerRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setBuzzerState(data);
                        } else if (registered) {
                            // Inicializar buzzer se n√£o existir
                            set(buzzerRef, { pressed: false, enabled: true, timestamp: null });
                        }
                    });

                    // Monitorizar se foi desconectado pelo master
                    const unsubClient = onValue(clientRef, (snapshot) => {
                        if (!snapshot.exists() && registered) {
                            // Mesa foi removida - desconectar
                            setRegistered(false);
                            setError('Foste desconectado pelo master. Por favor, conecta-te novamente.');
                            setGameData(null);
                            setMyTable(null);
                            setBuzzerState({ pressed: false, enabled: true });
                        }
                    });

                    return () => {
                        unsubGame();
                        unsubBuzzer();
                        unsubClient();
                    };
                }, [registered, sessionCode, tableNumber]);

                /* ==========================================
                   FUN√á√ÉO: handleRegister()
                   ==========================================
                   Regista o cliente na sess√£o:
                   1. Valida c√≥digo e n√∫mero de mesa
                   2. Verifica se sess√£o existe e est√° ativa
                   3. Regista cliente no Firebase
                   4. Inicializa buzzer
                   ========================================== */
                const handleRegister = async () => {
                    setError('');
                    
                    // Valida√ß√µes
                    if (!sessionCode.trim()) {
                        setError('C√≥digo da sess√£o √© obrigat√≥rio');
                        return;
                    }
                    
                    if (!tableNumber || tableNumber < 1 || tableNumber > 20) {
                        setError('N√∫mero da mesa inv√°lido (1-20)');
                        return;
                    }

                    setConnecting(true);

                    // Verificar se sess√£o existe
                    const sessionRef = ref(rtdb, `sessions/${sessionCode.toUpperCase()}/gameState`);
                    onValue(sessionRef, async (snapshot) => {
                        const data = snapshot.val();
                        if (!data || !data.active) {
                            setError('C√≥digo de sess√£o inv√°lido ou jogo n√£o iniciado');
                            setConnecting(false);
                        } else {
                            // Registar cliente
                            await set(ref(rtdb, `sessions/${sessionCode.toUpperCase()}/clients/${tableNumber}`), {
                                tableNumber: parseInt(tableNumber),
                                teamName: teamName || `Mesa ${tableNumber}`,
                                emails: emails.filter(e => e.trim()),
                                connectedAt: Date.now()
                            });

                            // Inicializar buzzer
                            await set(ref(rtdb, `sessions/${sessionCode.toUpperCase()}/buzzers/${tableNumber}`), {
                                pressed: false,
                                enabled: true,
                                timestamp: null
                            });

                            setSessionCode(sessionCode.toUpperCase());
                            setRegistered(true);
                            setConnecting(false);
                        }
                    }, (err) => {
                        setError('Erro ao conectar. Tenta novamente.');
                        setConnecting(false);
                    }, { onlyOnce: true });
                };

                /* ==========================================
                   FUN√á√ÉO: pressBuzzer()
                   ==========================================
                   Pressiona o buzzer:
                   1. Verifica se pode pressionar (enabled e n√£o pressed)
                   2. Verifica bloqueio por 0 pontos (se ativo)
                   3. Reproduz som
                   4. Atualiza estado no Firebase
                   ========================================== */
                const pressBuzzer = async () => {
                    if (!buzzerState.enabled || buzzerState.pressed) return;
                    
                    // Verificar bloqueio por 0 pontos
                    if (gameData?.blockBuzzerAtZero && myTable?.score === 0) {
                        return;
                    }

                    playBuzzer();

                    try {
                        await update(ref(rtdb, `sessions/${sessionCode}/buzzers/${tableNumber}`), {
                            pressed: true,
                            timestamp: Date.now(),
                            enabled: false
                        });
                    } catch (e) {
                        console.error('Erro ao pressionar buzzer:', e);
                    }
                };

                // Determinar se buzzer est√° bloqueado por 0 pontos
                const isBuzzerBlockedByZeroScore = gameData?.blockBuzzerAtZero && myTable?.score === 0;

                /* ==========================================
                   RENDERIZA√á√ÉO: Formul√°rio de Registo
                   ==========================================
                   Campos:
                   - C√≥digo da sess√£o (m√°x 10 caracteres)
                   - N√∫mero da mesa (1-20)
                   - Nome da equipa (opcional)
                   - E-mails dos participantes (opcional, m√∫ltiplos)
                   ========================================== */
                if (!registered) {
                    return h('div', { className: 'min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 p-4 flex items-center justify-center' },
                        h('div', { className: 'max-w-md w-full bg-white rounded-2xl shadow-2xl p-6' },
                            h('div', { className: 'text-center mb-6' },
                                h('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Registo de Mesa')
                            ),
                            // Mensagem de erro
                            error && h('div', { className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4' }, error),
                            h('div', { className: 'space-y-4' },
                                // Campo: C√≥digo da sess√£o
                                h('div', null,
                                    h('label', { className: 'block text-sm font-semibold text-gray-700 mb-2' }, 'C√≥digo da Sess√£o *'),
                                    h('input', {
                                        type: 'text',
                                        value: sessionCode,
                                        onChange: (e) => setSessionCode(e.target.value.toUpperCase()),
                                        placeholder: 'Ex: ABC123',
                                        maxLength: 10,
                                        className: 'w-full px-4 py-3 text-lg font-mono border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 uppercase'
                                    })
                                ),
                                // Campo: N√∫mero da mesa
                                h('div', null,
                                    h('label', { className: 'block text-sm font-semibold text-gray-700 mb-2' }, 'N√∫mero da Mesa *'),
                                    h('input', {
                                        type: 'number',
                                        min: 1,
                                        max: 20,
                                        value: tableNumber,
                                        onChange: (e) => setTableNumber(e.target.value),
                                        placeholder: '1-20',
                                        className: 'w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500'
                                    })
                                ),
                                // Campo: Nome da equipa
                                h('div', null,
                                    h('label', { className: 'block text-sm font-semibold text-gray-700 mb-2' }, 'Nome da Equipa'),
                                    h('input', {
                                        type: 'text',
                                        value: teamName,
                                        onChange: (e) => setTeamName(e.target.value),
                                        placeholder: 'Nome da vossa equipa',
                                        className: 'w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500'
                                    })
                                ),
                                // Campos: E-mails (m√∫ltiplos)
                                h('div', null,
                                    h('div', { className: 'flex items-center justify-between mb-2' },
                                        h('label', { className: 'block text-sm font-semibold text-gray-700' }, 'E-mails'),
                                        h('button', {
                                            onClick: () => setEmails([...emails, '']),
                                            className: 'text-sm text-purple-600 hover:text-purple-700 font-semibold'
                                        }, '+ Adicionar')
                                    ),
                                    h('div', { className: 'space-y-2 max-h-48 overflow-y-auto' },
                                        emails.map((email, index) =>
                                            h('div', { key: index, className: 'flex gap-2' },
                                                h('span', { className: 'text-gray-400 mt-3' }, '‚úâ'),
                                                h('input', {
                                                    type: 'email',
                                                    value: email,
                                                    onChange: (e) => {
                                                        const newEmails = [...emails];
                                                        newEmails[index] = e.target.value;
                                                        setEmails(newEmails);
                                                    },
                                                    placeholder: 'email@exemplo.com',
                                                    className: 'flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500'
                                                }),
                                                emails.length > 1 && h('button', {
                                                    onClick: () => setEmails(emails.filter((_, i) => i !== index)),
                                                    className: 'px-3 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600'
                                                }, '‚úï')
                                            )
                                        )
                                    )
                                ),
                                // Bot√£o de conex√£o
                                h('button', {
                                    onClick: handleRegister,
                                    disabled: connecting,
                                    className: `w-full py-4 rounded-lg text-lg font-bold transition-colors shadow-lg ${
                                        connecting ? 'bg-gray-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700 text-white'
                                    }`
                                }, connecting ? 'A Conectar...' : 'Conectar ao Jogo')
                            )
                        )
                    );
                }

                /* ==========================================
                   RENDERIZA√á√ÉO: Ecr√£ Principal do Cliente
                   ==========================================
                   Layout:
                   - Topo: Info da mesa (nome + c√≥digo sess√£o)
                   - Meio superior: Categorias (se existirem)
                   - Centro: Bot√£o de buzzer (grande)
                   - Fundo: Pontua√ß√£o atual
                   ========================================== */
                return h('div', { className: 'h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-blue-900 p-4 flex flex-col overflow-hidden' },
                    h('div', { className: 'max-w-4xl mx-auto w-full h-full flex flex-col' },
                        // Cabe√ßalho com info da mesa
                        h('div', { className: 'bg-white rounded-2xl shadow-2xl p-3 mb-3 flex-shrink-0' },
                            h('div', { className: 'flex items-center justify-between' },
                                h('div', null,
                                    h('div', { className: 'text-xs text-gray-600' }, `Mesa ${tableNumber}`),
                                    h('div', { className: 'text-lg font-bold text-gray-800' }, teamName || `Mesa ${tableNumber}`)
                                ),
                                h('div', { className: 'text-xs text-gray-500' }, `Sess√£o: ${sessionCode}`)
                            )
                        ),
                        // Categorias (amarela e vermelha)
                        gameData?.categories && gameData.categories.length > 0 && h('div', { className: 'grid grid-cols-2 gap-2 mb-3 flex-shrink-0' },
                            gameData.yellowCategory && h('div', { className: 'bg-yellow-400 text-gray-900 rounded-xl p-4 font-black shadow-xl flex items-center justify-center h-24' },
                                h('span', { className: 'text-center leading-tight text-lg sm:text-xl' }, gameData.yellowCategory)
                            ),
                            gameData.redCategory && h('div', { className: 'bg-red-500 text-white rounded-xl p-4 font-black shadow-xl flex items-center justify-center h-24' },
                                h('span', { className: 'text-center leading-tight text-lg sm:text-xl' }, gameData.redCategory)
                            )
                        ),
                        // Bot√£o de buzzer (grande, circular)
                        h('div', { className: 'flex-1 flex items-center justify-center' },
                            h('button', {
                                onClick: pressBuzzer,
                                disabled: !buzzerState.enabled || buzzerState.pressed || isBuzzerBlockedByZeroScore,
                                className: `w-56 h-56 sm:w-64 sm:h-64 rounded-full text-white font-black text-2xl sm:text-3xl shadow-2xl transition-all transform ${
                                    !buzzerState.enabled || buzzerState.pressed || isBuzzerBlockedByZeroScore
                                        ? 'bg-gray-400 cursor-not-allowed opacity-50' 
                                        : 'bg-red-600 hover:bg-red-700 hover:scale-105 active:scale-95'
                                }`
                            }, h('div', { className: 'flex flex-col items-center gap-2' },
                                h('div', { className: 'text-5xl' }, 
                                    buzzerState.pressed || isBuzzerBlockedByZeroScore ? 'üîí' : 'üîî'
                                ),
                                h('div', null, 
                                    buzzerState.pressed || isBuzzerBlockedByZeroScore ? 'BLOQUEADO' : (gameData?.buzzerText || 'BUZZER')
                                )
                            ))
                        ),
                        // Painel de pontua√ß√£o
                        h('div', { className: 'flex-shrink-0 mb-3' },
                            h('div', { className: 'bg-white rounded-2xl shadow-2xl p-6 text-center' },
                                h('div', { className: 'text-5xl sm:text-6xl font-black text-purple-600 mb-2' }, myTable?.score ?? '---'),
                                h('div', { className: 'text-lg text-gray-600 font-semibold' }, 'pontos')
                            )
                        ),
                        // Mensagem de aguardar (se jogo ainda n√£o iniciado)
                        !gameData && h('div', { className: 'text-center text-white' },
                            h('div', { className: 'animate-pulse' }, 'A aguardar in√≠cio do jogo...')
                        )
                    )
                );
            }

            // Renderizar aplica√ß√£o
            ReactDOM.createRoot(document.getElementById('root')).render(h(App));
        });
    </script>
</body>
</html>
